# Phase 2 Implementation Summary - Identity & Consent Services

## ‚úÖ Implementation Complete

**Date:** October 27, 2025  
**Phase:** Phase 2 - Identity & Consent Services  
**Status:** ‚úÖ **ALL SERVICES IMPLEMENTED**

---

## üìã Overview

Phase 2 focused on implementing the critical **identity management** and **privacy consent** infrastructure required for proper Salesforce Data Cloud integration. This phase enables the complete user journey from anonymous to known profiles, GDPR-compliant consent management, location tracking, and comprehensive debugging capabilities.

---

## üéØ Services Implemented

### 1. ‚úÖ ProfileDataService

**File:** `Sources/Core/Services/Salesforce/DataCloud/ProfileDataService.swift`  
**Lines:** 400+  
**Status:** ‚úÖ Complete

#### **Purpose:**
Manages user identity state and profile attributes throughout the user lifecycle, enabling anonymous-to-known user transitions and profile enrichment.

#### **Key Features:**

- **setAnonymousProfile()** - Initialize user as anonymous
  - Called automatically on app launch
  - Resets user to anonymous state on logout
  - Uses `CdpModule.shared.setProfileToAnonymous()`

- **setKnownProfile(firstName:lastName:email:)** - Transition to known user
  - Called after user login/signup
  - Uses `CdpModule.shared.setProfileToKnown()`
  - Sends identity attributes via `SFMCSdk.identity.setProfileAttributes()`
  - Automatically captures device information
  - **Links all past anonymous events to the known user**

- **captureDeviceInformation()** - Capture device attributes
  - Device type (iPhone, iPad, etc.)
  - App name and version
  - OS version
  - Advertiser ID (with ATTrackingManager authorization)
  - Integrates with iOS 14+ App Tracking Transparency

- **updateContactInformation(phone:address:)** - Enrich profile
  - Phone number
  - Address (line1, line2, city, state, postal code, country)
  - Can update phone and address independently

- **State Management**
  - Observable `isKnownUser` property for SwiftUI
  - Observable `profileState` property (anonymous/known)
  - Persistent state storage in UserDefaults
  - Automatic restoration on app relaunch

#### **Identity Lifecycle Flow:**

```
App Launch
    ‚Üì
SDK Initialization Complete
    ‚Üì
setAnonymousProfile() ‚Üê User starts as anonymous
    ‚Üì
[User browses - events tagged with anonymous ID]
    ‚Üì
User Signs Up / Logs In
    ‚Üì
setKnownProfile(firstName, lastName, email)
    ‚Üì
    ‚îú‚îÄ> CdpModule.setProfileToKnown()
    ‚îú‚îÄ> SFMCSdk.identity.setProfileAttributes(attributes)
    ‚îî‚îÄ> captureDeviceInformation()
    ‚Üì
[All past anonymous events NOW linked to known user!]
    ‚Üì
[All future events include identity attributes automatically]
```

#### **Usage Examples:**

```swift
// Set anonymous profile (automatic on app launch)
ProfileDataService.shared.setAnonymousProfile()

// Set known profile (after login)
ProfileDataService.shared.setKnownProfile(
    firstName: "John",
    lastName: "Doe",
    email: "john@example.com"
)

// Capture device information
ProfileDataService.shared.captureDeviceInformation()

// Update contact information
let address = Address(
    line1: "123 Main St",
    city: "San Francisco",
    state: "CA",
    postalCode: "94105",
    country: "USA"
)
ProfileDataService.shared.updateContactInformation(
    phone: "+1-555-123-4567",
    address: address
)

// Check if user is known
if ProfileDataService.shared.isKnownUser {
    // Show personalized content
}
```

---

### 2. ‚úÖ ConsentService

**File:** `Sources/Core/Services/Salesforce/DataCloud/ConsentService.swift`  
**Lines:** 150+  
**Status:** ‚úÖ Complete

#### **Purpose:**
Manages user privacy consent for data collection and tracking, ensuring GDPR compliance by gating all event tracking behind user consent.

#### **Key Features:**

- **setConsent(isOptedIn:)** - Set consent status
  - Opt in: Enables all event tracking
  - Opt out: Disables all event tracking
  - Uses `CdpModule.shared.setConsent(consent: .optIn/.optOut)`

- **getCurrentConsent()** - Get current consent status
  - Returns `Consent.optIn`, `Consent.optOut`, or `Consent.notSet`

- **isOptedIn()** / **isOptedOut()** - Convenience checks
  - Boolean helpers for quick consent checks

- **Persistent Storage**
  - Saves consent preference to UserDefaults
  - Automatically loads saved consent on initialization

- **Notifications**
  - Posts `.consentStatusChanged` notification on changes
  - UI can observe and react to consent changes

#### **GDPR Compliance:**

‚úÖ **All event tracking respects consent**
- Events are ONLY tracked when `consentStatus == .optIn`
- Consent can be changed at any time
- Opt-out immediately stops all tracking
- Consent state persists across app sessions

#### **Usage Examples:**

```swift
// Opt in to data collection
ConsentService.shared.setConsent(isOptedIn: true)

// Opt out of data collection
ConsentService.shared.setConsent(isOptedIn: false)

// Check consent status
let consent = ConsentService.shared.getCurrentConsent()
if consent == .optIn {
    // Track events
}

// Boolean checks
if ConsentService.shared.isOptedIn() {
    // User has consented to tracking
}

// Listen for consent changes
NotificationCenter.default.addObserver(
    forName: .consentStatusChanged,
    object: nil,
    queue: .main
) { notification in
    if let status = notification.userInfo?["status"] as? ConsentStatus {
        // Handle consent change
    }
}
```

---

### 3. ‚úÖ LocationTrackingService

**File:** `Sources/Core/Services/Salesforce/DataCloud/LocationTrackingService.swift`  
**Lines:** 300+  
**Status:** ‚úÖ Complete

#### **Purpose:**
Manages GPS location tracking and sends location data to Salesforce Data Cloud for location-aware personalization and analytics.

#### **Key Features:**

- **CoreLocation Integration**
  - Uses `CLLocationManager` for GPS tracking
  - Handles location authorization (When In Use / Always)
  - Manages location updates automatically

- **CDP Module Integration**
  - Sends coordinates to Data Cloud via `CdpModule.shared.setLocation()`
  - Uses `CdpCoordinates` for proper format
  - Sets expiration time (60 seconds)

- **Location Settings**
  - Desired accuracy: `kCLLocationAccuracyHundredMeters` (100m)
  - Distance filter: 100 meters (updates every 100m of movement)
  - Location expiration: 60 seconds

- **Lifecycle Management**
  - `startTracking()` - Start continuous location updates
  - `stopTracking()` - Stop updates and clear Data Cloud location
  - `requestLocationPermission()` - Request user authorization
  - `requestSingleLocation()` - One-time location request

- **Observable Properties**
  - `@Published var currentLocation: CLLocation?`
  - `@Published var authorizationStatus: CLAuthorizationStatus`
  - `@Published var isTracking: Bool`

- **Notifications**
  - `.locationUpdated` - Location coordinates updated
  - `.locationAuthorizationChanged` - Authorization status changed
  - `.locationError` - Location error occurred

#### **Location Data Flow:**

```
User grants location permission
    ‚Üì
startTracking() called
    ‚Üì
CLLocationManager starts updating location
    ‚Üì
didUpdateLocations delegate method called
    ‚Üì
CdpCoordinates created from CLLocation
    ‚Üì
CdpModule.shared.setLocation(coordinates, expiresIn: 60)
    ‚Üì
Location sent to Data Cloud
    ‚Üì
[Location automatically attached to all subsequent events]
    ‚Üì
After 60 seconds: Location expires
    ‚Üì
Next location update refreshes the data
```

#### **Usage Examples:**

```swift
// Request location permission
LocationTrackingService.shared.requestLocationPermission()

// Start continuous tracking
LocationTrackingService.shared.startTracking()

// Stop tracking
LocationTrackingService.shared.stopTracking()

// Request single location
LocationTrackingService.shared.requestSingleLocation()

// Observe current location
let location = LocationTrackingService.shared.currentLocation

// Check authorization status
let status = LocationTrackingService.shared.authorizationStatus

// Debug: Simulate location
#if DEBUG
LocationTrackingService.shared.simulateLocation(
    latitude: 37.7749,
    longitude: -122.4194
)
#endif
```

---

### 4. ‚úÖ DataCloudLoggingService

**File:** `Sources/Core/Services/Salesforce/DataCloud/DataCloudLoggingService.swift`  
**Lines:** 300+  
**Status:** ‚úÖ Complete

#### **Purpose:**
Provides structured logging for debugging Salesforce Data Cloud SDK integration and monitoring CDP events.

#### **Key Features:**

- **Structured Logging Methods**
  - `debug(_ message:)` - Debug-level logging
  - `info(_ message:)` - Informational messages
  - `warning(_ message:)` - Warnings
  - `error(_ message:)` - Errors
  - `fault(_ message:)` - Critical failures

- **SDK Status Methods**
  - `getSdkState()` - Get current SDK state
  - `getCdpModuleStatus()` - Get CDP module status
  - `isCdpModuleOperational()` - Check if operational
  - `printSdkStatus()` - Print comprehensive status report

- **Event Logging**
  - `logEventTracked(eventName:attributes:)` - Log event tracking
  - `logIdentityChange(state:attributes:)` - Log identity changes
  - `logLocationUpdate(latitude:longitude:accuracy:)` - Log location updates
  - `logConsentChange(status:)` - Log consent changes

- **Convenience Methods**
  - `success(_ message:)` - Log success with ‚úÖ
  - `failure(_ message:)` - Log failure with ‚ùå
  - `progress(_ message:)` - Log progress with ‚è≥
  - `config(_ message:)` - Log configuration with üîß
  - `network(_ message:)` - Log network with üì°

- **Debug-Only Logging**
  - Logging only enabled in DEBUG builds
  - No performance impact in production

#### **Usage Examples:**

```swift
// Log debug message
DataCloudLoggingService.shared.debug("SDK initialized successfully")

// Log error
DataCloudLoggingService.shared.error("Failed to track event")

// Log event tracking
DataCloudLoggingService.shared.logEventTracked(
    eventName: "AddToCart",
    attributes: ["productId": "prod-123", "quantity": 1]
)

// Log identity change
DataCloudLoggingService.shared.logIdentityChange(
    state: "known",
    attributes: ["firstName": "John", "email": "john@example.com"]
)

// Print SDK status
DataCloudLoggingService.shared.printSdkStatus()

// Output:
// ============================================================
// üìä SFMC SDK Status Report
// ============================================================
// SDK State: operational
// CDP Module Status: operational
// CDP Module Operational: ‚úÖ YES
// Consent Status: optIn
// ============================================================

// Check if operational
if DataCloudLoggingService.shared.isCdpModuleOperational() {
    // SDK is ready
}

// Convenience logging
DataCloudLoggingService.shared.success("Profile updated")
DataCloudLoggingService.shared.failure("Network error")
```

---

### 5. ‚úÖ ScreenTrackingViewModifier

**File:** `Sources/Shared/UI/Modifiers/ScreenTrackingViewModifier.swift`  
**Lines:** 80+  
**Status:** ‚úÖ Complete

#### **Purpose:**
SwiftUI view modifier for automatic screen view tracking when views appear.

#### **Key Features:**

- **Automatic Tracking**
  - Tracks screen view on `.onAppear`
  - No manual tracking code needed in ViewModels

- **Consent-Aware**
  - Checks consent before tracking
  - Respects user privacy preferences

- **SFMC SDK Integration**
  - Uses `CustomEvent` with "ScreenView" name
  - Sends `screen_name` attribute

- **Easy to Use**
  - Simple `.trackScreen("ScreenName")` modifier
  - Works with any SwiftUI view

#### **Usage Examples:**

```swift
// Track screen view
struct HomeView: View {
    var body: some View {
        VStack {
            Text("Welcome Home")
        }
        .trackScreen("Home")
    }
}

// Track screen with dynamic name
struct ProductDetailView: View {
    let product: Product
    
    var body: some View {
        VStack {
            Text(product.name)
        }
        .trackScreen("ProductDetail_\(product.id)")
    }
}

// Works with any view
NavigationView {
    List {
        // Content
    }
    .trackScreen("ProductList")
}
```

**Event Data Structure:**

```json
{
  "event_name": "ScreenView",
  "attributes": {
    "screen_name": "Home"
  }
}
```

---

### 6. ‚úÖ LocationAwareViewModifier

**File:** `Sources/Shared/UI/Modifiers/LocationAwareViewModifier.swift`  
**Lines:** 100+  
**Status:** ‚úÖ Complete

#### **Purpose:**
SwiftUI view modifier for automatic location tracking based on view lifecycle.

#### **Key Features:**

- **Automatic Lifecycle Management**
  - Starts tracking on `.onAppear`
  - Stops tracking on `.onDisappear`
  - No manual start/stop needed

- **LocationTrackingService Integration**
  - Uses `LocationTrackingService.shared`
  - Handles all location logic automatically

- **Conditional Tracking**
  - Can enable/disable tracking with boolean parameter
  - Useful for user preferences

#### **Usage Examples:**

```swift
// Always track location when view is visible
struct ProductCardView: View {
    var body: some View {
        VStack {
            // Product content
        }
        .locationAware()
    }
}

// Conditional location tracking
struct MapView: View {
    @AppStorage("enableLocation") var enableLocation = true
    
    var body: some View {
        Map()
            .locationAware(isEnabled: enableLocation)
    }
}

// Combine with screen tracking
struct RestaurantView: View {
    var body: some View {
        VStack {
            // Restaurant content
        }
        .trackScreen("Restaurant")
        .locationAware()
    }
}
```

---

## üîÑ Service Integration Flow

```
App Launch
    ‚Üì
DataCloudService.configureSdk()
    ‚Üì
SDK Initialization Complete
    ‚Üì
ProfileDataService.setAnonymousProfile()
    ‚Üì
ConsentService loads saved consent
    ‚Üì
LocationTrackingService ready
    ‚Üì
[User browses as anonymous]
    ‚Üì
User navigates to screen
    ‚Üì
ScreenTrackingViewModifier tracks screen view
    ‚Üì
LocationAwareViewModifier starts location tracking
    ‚Üì
[User interacts with app]
    ‚Üì
User signs up/logs in
    ‚Üì
ProfileDataService.setKnownProfile()
    ‚Üì
[Identity resolution - anonymous events linked to known user]
    ‚Üì
User opts in to tracking
    ‚Üì
ConsentService.setConsent(isOptedIn: true)
    ‚Üì
[All events now tracked with full identity + location context]
```

---

## üìä Event Data Propagation

### **How Identity Attributes Are Attached to Events:**

```
1. ProfileDataService.setProfileAttributes({firstName, email})
                    ‚Üì
       [Attributes stored in SDK]
                    ‚Üì
         [Any event tracked]
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AddToCartEvent                                   ‚îÇ
‚îÇ {                                                ‚îÇ
‚îÇ   "catalogObjectId": "prod-123",                ‚îÇ
‚îÇ   "quantity": 1,                                ‚îÇ
‚îÇ   "firstName": "John",      ‚Üê Auto-included     ‚îÇ
‚îÇ   "email": "john@example.com"  ‚Üê Auto-included  ‚îÇ
‚îÇ }                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **How Location Data Is Attached:**

```
LocationTrackingService.startTracking()
                    ‚Üì
    CdpModule.setLocation(coordinates)
                    ‚Üì
         [Any event tracked]
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ViewCatalogObjectEvent                           ‚îÇ
‚îÇ {                                                ‚îÇ
‚îÇ   "catalogObjectId": "prod-123",                ‚îÇ
‚îÇ   "type": "ProductBrowse",                      ‚îÇ
‚îÇ   "latitude": 37.7749,     ‚Üê Auto-included      ‚îÇ
‚îÇ   "longitude": -122.4194    ‚Üê Auto-included     ‚îÇ
‚îÇ }                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Next Steps (Phase 3)

### **Pending Implementation:**

- [ ] Update App initialization to call `ProfileDataService.setAnonymousProfile()`
- [ ] Implement Screen View tracking in all views
- [ ] Update CartViewModel with complete tracking
- [ ] Update HomeViewModel with complete tracking
- [ ] Implement Product View tracking in ProductCardView
- [ ] Add ProfileViewModel for user profile management
- [ ] Create consent UI (ConsentView)
- [ ] Create location permission UI
- [ ] Create comprehensive tracking documentation

---

## üìö Files Created

### **Services (4 files):**
1. `Sources/Core/Services/Salesforce/DataCloud/ProfileDataService.swift` (400+ lines)
2. `Sources/Core/Services/Salesforce/DataCloud/ConsentService.swift` (150+ lines)
3. `Sources/Core/Services/Salesforce/DataCloud/LocationTrackingService.swift` (300+ lines)
4. `Sources/Core/Services/Salesforce/DataCloud/DataCloudLoggingService.swift` (300+ lines)

### **View Modifiers (2 files):**
5. `Sources/Shared/UI/Modifiers/ScreenTrackingViewModifier.swift` (80+ lines)
6. `Sources/Shared/UI/Modifiers/LocationAwareViewModifier.swift` (100+ lines)

### **Models:**
- `Address` struct in ProfileDataService
- `ProfileState` enum in ProfileDataService
- `ConsentStatus` enum in ConsentService

### **Total Lines of Code:** 1,330+ lines

---

## ‚ú® Key Achievements

‚úÖ **Complete Identity Management**
- Anonymous ‚Üí Known user transition
- Device information capture
- Contact information enrichment
- ATTrackingManager iOS 14+ integration

‚úÖ **GDPR-Compliant Consent Management**
- Opt-in/opt-out functionality
- Persistent consent storage
- Event tracking gated by consent

‚úÖ **Full Location Tracking**
- CoreLocation integration
- CDP Module location updates
- Automatic lifecycle management

‚úÖ **Comprehensive Debugging**
- Structured logging
- SDK status monitoring
- Event tracking logs

‚úÖ **SwiftUI View Modifiers**
- Automatic screen tracking
- Automatic location tracking
- Lifecycle-aware

---

## üéâ Summary

**Phase 2 is COMPLETE!** We've successfully implemented all critical identity, consent, and location tracking infrastructure following the AcmeDigitalStore pattern. The foundation is now in place for:

1. ‚úÖ Anonymous to known user journeys
2. ‚úÖ Privacy-compliant event tracking
3. ‚úÖ Location-aware personalization
4. ‚úÖ Complete debugging capabilities
5. ‚úÖ Automatic screen and location tracking

**Next:** Phase 3 will focus on integrating these services into ViewModels and Views throughout the app.

---

**Implementation Date:** October 27, 2025  
**Status:** ‚úÖ Phase 2 Complete  
**Next Phase:** Phase 3 - ViewModel & UI Integration

---

**End of Phase 2 Summary**

